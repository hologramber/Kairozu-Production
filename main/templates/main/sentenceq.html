{% extends 'kairozu.html' %}
{% block title %}Kairozu {{ chapter.title }}・{{ lesson.id }} クイズ{% endblock %}
{% block sidecollapse %}
    {% include 'main/sidecollapse.html' %}
{% endblock %}

{% load static %}
{% block content %}

{% include 'main/sentenceq_base.html' %}

<!-- wanakana, menu toggle, and get/post mechanics -->
<script type='text/javascript' src='{% static 'js/wanakana.js' %}'></script>
<script type='text/javascript' src='{% static 'js/cookiemonster.js' %}'></script>

<script type='text/javascript'>
    var input = document.getElementById('attempt');
    wanakana.bind(input);

    var english = $('#english'),
        literal = $('#literal'),
        context = $('#context'),
        hint = $('#hint'),
        quiz = $('#quiz'),
        attempt = $('#attempt'),
        pagewrap = $('#wrapper'),
        savestat = $('#savenow'),
        bug = $('#bug-button');

    var qdata = [],
        qcount = 0,
        q = 0,
        totalq = 0,
        level = 3,
        repeat = 0;


    function saveq() {
        savestat.html('<i class=\'fa fa-save fa-spin orange-words\' aria-hidden=\'true\'></i>');
        $.ajax({
            type: "POST",
            url: "{% url 'main:sentencesave' lesson.id %}",
            dataType: 'json',
            data: {qdata: JSON.stringify(qdata)},
            success: function (data) {
                if (data.error) {
                    location.reload();
                } else {
                    qcount = 0;
                    savestat.html('<i class=\'fa fa-save green-words\' aria-hidden=\'true\'></i>');
                }
            }
        });
    }

    function sentence() {
        context.html('&#8203;' + qdata[q]['sentence']['context'] + '&#8203;');
        literal.html('<div class="white-words litcontextbox upper">literal</div>' + qdata[q]['sentence']['literal'] + '&#8203;');
        english.html(qdata[q]['sentence']['english']);
        {% if user.profile.preferkanji %}
            switch(level) {
                case 3:
                    if (qdata[q]['sentence']['disamb_location'] != 0) {
                        hint.html(qdata[q]['sentence']['kanji_all_blank']);
                        hint.addClass('ls5y');
                    } else {
                        hint.html('&#8203;');
                    } break;
                case 2:
                    hint.html(qdata[q]['sentence']['kanji_all_blank']);
                    hint.removeClass('ls5y');
                    break;
                case 1:
                    hint.html(qdata[q]['sentence']['kanji_alt_blank']); break;
                default:
                    hint.html(qdata[q]['sentence']['f_kanji']); break;
            }
        {% else %}
            switch(level) {
                case 3:
                    if (qdata[q]['sentence']['disamb_location'] != 0) {
                        hint.html(qdata[q]['sentence']['kana_all_blank']);
                        hint.addClass('ls5y');
                    } else {
                        hint.html('&#8203;');
                    } break;
                case 2:
                    hint.html(qdata[q]['sentence']['kana_all_blank']);
                    hint.removeClass('ls5y');
                    break;
                case 1:
                    hint.html(qdata[q]['sentence']['kana_alt_blank']); break;
                default:
                    hint.html(qdata[q]['sentence']['f_kana']); break;
            }
        {% endif %}
    }


    function processQuiz(attempt) {
        if (attempt === 1) {
            bug.hide();
            quiz.removeClass("abox_red");
            quiz.addClass("abox_g").one(
                "webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",
                function() { quiz.removeClass("abox_g"); });
            qdata[q]['last_attempt'] = addTime(0);
            if (level === 3) {
                if (repeat) {
                    qdata.push(qdata.splice(q,1)[0]);
                    repeat = 0;
                } else {
                    qdata[q]['rating'] = qdata[q]['rating'] + 1;
                    if (!qdata[q]['next_review']) {
                        qdata[q]['next_review'] = addTime(1);
                    }
                    q++;
                }
                qcount++;
            } else {
                level = 3;
                repeat = 1;
            }
        } else {
            bug.show();
            quiz.addClass("abox_red abox_r").one(
                "webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",
                function() { quiz.removeClass("abox_r"); });
            qdata[q]['rating'] = 0;
            if (level > 0) { level--; }
        }
        savestat.html('<a href=\'#\' onclick=\'saveq()\'><i class=\'fa fa-save\' aria-hidden=\'true\'></i></a>');
        if (q < totalq) {
            quiz[0].reset();
            if (qcount > 9) {
                saveq();
            }
            sentence();
        } else {
            $('#extra').hide();
            $('#sentenceholder').html('<div class=\'text-align-center vocab-challenge\'><i class=\'fa fa-refresh fa-3x fa-spin orange-words\' aria-hidden=\'true\'></i></div>');
            $.ajax({
                type: "POST",
                url: "{% url 'main:sentencefinish' lesson.id %}",
                data: {qdata: JSON.stringify(qdata)},
                success: function (data) {
                    if ((data.error) || (data.loop)) {
                        location.reload();
                    } else {
                        pagewrap.html(data);
                    }
                }
            });
        }
    }

    quiz.submit(function(event) {
        event.preventDefault();
        if (attempt.val() !== '') {
            var clean = cleanInput(attempt.val());
            {% if user.profile.preferkanji %}
                var actual = qdata[q]['sentence']['kanji_clean'];
            {% else %}
                var actual = qdata[q]['sentence']['kana_clean'];
            {% endif %}
            if ('{{ user.profile.strictmode }}' === 'True' || (qdata[q]['sentence']['strict'])) {
                if (clean === actual) {
                    processQuiz(1);
                } else {
                    processQuiz(0);
                }
            } else {
                actual = actual.split("");
                clean = clean.split("");
                if (wanakana.compare(clean, actual)) {
                    processQuiz(1);
                } else {
                    processQuiz(0);
                }
            }
        }
    });

    $(document).ready(function() {
        $.get("{% url 'main:sentencegrab' lesson.id %}").done(function (data) {
            qdata = data;
            totalq = qdata.length;
            if (totalq > 0) {
                sentence();
            } else {
                $.get("{% url 'main:sentencesuccess' lesson.id %}").done(function (data) {
                    pagewrap.html(data);
                });
            }
        });
    });
</script>

{% endblock %}
