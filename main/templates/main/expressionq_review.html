{% extends 'kairozu.html' %}
{% block title %}Kairozu Expression Review{% endblock %}

{% load static %}
{% block content %}

<div id="allwrap">
    <div class="fc-basic">
        {% include 'main/expressionq_base.html' %}
    </div>

    <div class="fc-basic">
        <div class="reference-link smaller">
            <a id="reflink" href="">View Expression List</a>
        </div>

        <div id="example" style="display: none;">
            <i class="fa fa-info-circle green-words" aria-hidden="true"></i>&nbsp;&nbsp;<span id="prompt-text" class="grey-words smaller"></span>
        </div>

        <div id="katakana" style="display: none;">
            <i class="fa fa-star red-words" aria-hidden="true"></i>&nbsp;&nbsp;<span class="grey-words smaller">This expression uses katakana characters (press shift when typing).</span>
        </div>
    </div>
</div>

<div class="s-100"></div>

<!-- wanakana, menu toggle, and get/post mechanics -->
<script type='text/javascript' src='{% static 'js/wanakana.js' %}'></script>
<script type='text/javascript' src='{% static 'js/cookiemonster.js' %}'></script>

<script type='text/javascript'>
    var input = document.getElementById('attempt');
    wanakana.bind(input);

    var english = $('#english'),
        literal = $('#literal'),
        context = $('#context'),
        hint = $('#hint'),
        example = $('#example'),
        quiz = $('#quiz'),
        attempt = $('#attempt'),
        pagewrap = $('#allwrap'),
        katakana = $('#katakana'),
        reflink = $("#reflink"),
        savestat = $('#savenow'),
        bug = $('#bug-button');

    var qdata = [],
        qcount = 0,
        q = 0,
        totalq = 0,
        level = 2,
        repeat = 0;

    function expression() {
        context.html('&#8203;' + qdata[q]['express']['context'] + '&#8203;');
        english.html(qdata[q]['express']['english']);
        literal.html('<div class="white-words litcontextbox upper">literal</div>' + qdata[q]['express']['literal'] + '&#8203;');
        reflink.attr("href", '/main/chapter/' + qdata[q]['express']['chapter'] + '/expressionlist/');
        switch(level) {
            case 2:
                hint.html(qdata[q]['express']['kana_all_blank']); break;
            case 1:
                hint.html(qdata[q]['express']['kana_alt_blank']); break;
            default:
                hint.html(qdata[q]['express']['f_kana']); break;
        }
        if (qdata[q]['express']['katakana']) { katakana.show(); } else { katakana.hide(); }
        if (qdata[q]['express']['example']) {
            example.show();
            example.html('Example: ' + qdata[q]['express']['example'])
        } else {
            example.hide();
        }
    }

    function getq() {
        $.get("{% url 'main:reviewexpressiongrab' %}").done(function (data) {
            qdata = data;
            totalq = qdata.length;
            q = 0;
            if (totalq > 0) {
                expression();
            } else {
                $.get("{% url 'main:reviewexpressioncurrent' %}").done(function (data) {
                    pagewrap.html(data);
                });
            }
        });
    }

    function saveq() {
        savestat.html('<i class=\'fa fa-save fa-spin orange-words\' aria-hidden=\'true\'></i>');
        if (q < totalq) {
            expression();
        } else {
            katakana.hide();
            example.hide();
            literal.html('&#8203;');
            hint.html('&#8203;');
            context.html('&#8203;');
            english.html('<i class=\'fa fa-refresh fa-4x fa-spin orange-words\' aria-hidden=\'true\'></i>');
        }
        $.ajax({
            type: "POST",
            url: "{% url 'main:reviewexpressionsave' %}",
            dataType: 'json',
            data: {qdata: JSON.stringify(qdata)},
            success: function (data) {
                if (data.error) {
                    location.reload();
                } else {
                    qcount = 0;
                    savestat.html('<i class=\'fa fa-save green-words\' aria-hidden=\'true\'></i>');
                    if (q >= totalq) {
                        getq();
                    }
                }
            }
        });
    }

    quiz.submit(function(event) {
        event.preventDefault();
        if (attempt.val() !== '') {
            var clean = cleanInput(attempt.val());
            if (clean === qdata[q]['express']['kana_clean']) {
                bug.hide();
                hint.attr('class', 'ls5');
                quiz.removeClass("abox_red");
                quiz.addClass("abox_g").one(
                    "webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",
                    function () {
                        quiz.removeClass("abox_g");
                    });
                qdata[q]['last_attempt'] = addTime(0);
                if (level === 2) {
                    if (repeat) {
                        qdata[q]['next_review'] = addTime(1);
                        repeat = 0;
                    } else {
                        qdata[q]['score'] = qdata[q]['score'] + 1;
                        qdata[q]['next_review'] = addTime(qdata[q]['score']);
                    }
                    q++;
                    qcount++;
                } else {
                    level = 2;
                    repeat = 1;
                }
            } else {
                bug.show();
                hint.attr('class', 'ls5r');
                quiz.addClass("abox_red abox_r").one(
                    "webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",
                    function () {
                        quiz.removeClass("abox_r");
                    });
                qdata[q]['score'] = 0;
                if (level > 0) {
                    level--;
                }
            }
            savestat.html('<a href=\'#\' onclick=\'saveq()\'><i class=\'fa fa-save\' aria-hidden=\'true\'></i></a>');
            quiz[0].reset();
            if (((q < totalq) && (qcount > 9)) || (q >= totalq)) {
                saveq();
            } else {
                expression();
            }
        }
    });

    $(document).ready(function() { getq(); });
</script>

{% endblock %}
